$(function(){function a(a){var c=this;this.container=$("#"+a),this.printTopBar().printFingers(function(){c.printMusicBtn()}),this.popup=new b(this)}function b(a){var b=this;this.par=a;var c=$("<div>").addClass("int_popup_wrapper").appendTo(this.par.container);this.container=$("<div>").addClass("int_popup").appendTo(c),this.btn_ex=$("<div>").addClass("btn_ex").html("x").appendTo(this.container).click(function(){b.hide(!0)})}function c(a){var b,c,d,e=a.length;if(0===e)return!1;for(;--e;)b=Math.floor(Math.random()*(e+1)),c=a[e],d=a[b],a[e]=d,a[b]=c}var d="http://www.slate.com/features/2014/06/murakami/";require.config({paths:{IntSound:d+"lib/intSound/intSound",SoundJS:d+"lib/soundjs/soundjs.min",SJS_FlashPlugin:d+"lib/soundjs/FlashPlugin",SJS_SwfObject:d+"lib/soundjs/swfobject",imagesLoaded:d+"lib/imagesLoaded.min"}});var e=["red","blue","white","black","map"],f={red:"note_e",blue:"note_g",white:"note_a",black:"note_a_sharp",map:"note_b"},g=["e","g","a","b","a_sharp","b","g","e"];a.prototype={printTopBar:function(){var a=this,b=$("<div>").addClass("top_bar").html("Please turn your sound up");return this.right_wrapper=$("<div>").addClass("right_wrapper").appendTo(b).click(function(){a.muteSound()}),$("<span>").addClass("btn_mute").html("mute sound").appendTo(this.right_wrapper),this.top_bar_wrapper=b.appendTo(this.container),this},muteSound:function(){this.sound_muted=!0},printMusicBtn:function(){var a=this;return this.btn_music=$("<div>").hide().addClass("btn_music").appendTo(this.right_wrapper).fadeIn().click(function(){$(this).hasClass("active")?a.deactivatePianoView():a.activatePianoView()}),this},printFingers:function(a){var b=this,c=["red","blue","white","black","map"];return this.fingers_wrapper=$("<div>").addClass("fingers_wrapper").appendTo(this.container),this.fingers={},c.forEach(function(a,c){setTimeout(function(){var c=$("<div>").addClass("finger").data("type",a).addClass("finger_"+a).appendTo(b.fingers_wrapper).fadeIn().click(function(){b.fingerClicked(a)});b.fingers[a]=c},200*c)}),setTimeout(a||null,1e3),this},fingerClicked:function(a){this.piano_view||this.popup.trigger(a)},addSoundListeners:function(){function a(a){for(var b in c.fingers)c.puzzle_complete||a.tieToButton(c.fingers[b],"sound/",f[b],{behavior:"key"})}function b(){var a=$(this).data("type");c.fingerPlayed(a)}var c=this;if(require(["IntSound"],function(b){b.initialize(d+"lib/soundjs",a)}),!c.puzzle_complete)for(var e in c.fingers)c.fingers.hasOwnProperty(e)&&c.fingers[e].unbind("click.piano").on("click.piano",b)},removeSoundListeners:function(){var a=$(".finger").unbind("click.piano");require(["IntSound"],function(b){b.untieButton(a)})},fingerPlayed:function(a){this.played_notes||(this.played_notes=[]);var b=f[a].replace("note_","");g[this.played_notes.length]===b?(this.notes[this.played_notes.length].html("&#9834;").addClass("correct"),this.played_notes.push(b),this.played_notes.length===g.length&&this.win()):(this.played_notes=[],this.bot.find(".correct").removeClass("correct")),this.highlightNote(a)},highlightNote:function(a){var b=this.piano_overlays[a];b.fadeIn(100,function(){b.fadeOut()})},win:function(){var a=this;this.puzzle_complete=!0,$(".finger").unbind("click.piano"),require(["IntSound"],function(a){a.untieButton($(".finger"))}),setTimeout(function(){require(["IntSound"],function(a){a.playSound("sound/","note_b_1")}),a.highlightNote("final")},1e3),setTimeout(function(){a.showSolution()},1500)},printNotes:function(a){function b(){var a=$("<div>").html("&#9834;").addClass("note").appendTo(c.bot).animate({opacity:1},300);c.notes.push(a)}var c=this;this.notes=[];for(var d=g.length,e=0;d>e;e++)setTimeout(b,100*e);setTimeout(function(){a&&a()},700)},lowerFingers:function(a){this.fingers_wrapper.animate({"margin-top":300},500,function(){a&&a()})},raiseFingers:function(a){this.fingers_wrapper.animate({"margin-top":240},500,function(){a&&a()})},activatePianoView:function(){this.addSoundListeners(),this.piano_view=!0,this.popup.hide().disable(),this.btn_music.addClass("active"),this.showPiano(),this.showBot()},deactivatePianoView:function(){this.removeSoundListeners(),this.btn_music.removeClass("active"),this.hidePiano(),this.hideBot(),this.popup.enable()},showPiano:function(){var a=this;return this.fingers_wrapper.animate({"margin-top":210},500),this.piano||(!function(){a.piano=$("<div>").addClass("piano").appendTo(a.container).show()}(),function(){a.piano_overlays={},a.overlay_wrapper||(a.overlay_wrapper=$("<div>").addClass("overlay_wrapper").appendTo(a.fingers_wrapper));var b=e.slice(0,e.length);b.push("final"),b.forEach(function(b){a.piano_overlays[b]=$("<img>").attr("src",d+"graphics/pianokey_"+b+".png").addClass("piano_overlay").addClass(b).appendTo(a.overlay_wrapper)})}()),this.piano.css("opacity",0).animate({opacity:1,top:a.top_bar_wrapper.outerHeight()},500),this},hidePiano:function(){var a=this;return this.piano_view=!1,this.piano.animate({opacity:0,top:-250},500,function(){a.hideBot()}),this.fingers_wrapper.animate({"margin-top":140},500),this},showBot:function(a){var b=this,c=!1;this.bot||(this.bot=$("<div>").addClass("bot").appendTo(this.container),c=!0),this.bot.fadeIn().animate({opacity:1,bottom:0},300,function(){c?b.printNotes(a):a&&a()})},hideBot:function(){this.bot.fadeOut()},getSolution:function(a){var b=this;this.solution?a(this.solution):$.getJSON("solution.json",function(c){b.solution=c.solution,a(c.solution)})},showSolution:function(){var a=this;this.getSolution(function(b){{var c=$("<div>").addClass("solution_wrapper").appendTo(a.container);$("<div>").addClass("book_wrapper").html(b).appendTo(c),$("<p>").addClass("solution_title").prependTo(c),$("<div>").addClass("btn_ex").appendTo(c).html("X").click(function(){a.hideSolution(),a.resetPuzzle()})}a.solution_wrapper=c.fadeIn()})},hideSolution:function(){var a=this;this.solution_wrapper&&this.solution_wrapper.fadeOut(function(){a.solution_wrapper.remove()})},resetPuzzle:function(){this.container.find(".note.correct").removeClass("correct"),this.played_notes=[],this.puzzle_complete=!1,this.addSoundListeners()}},b.prototype={trigger:function(a){var b=this;this.container.hide(),this.loadData(function(){b.selectContent(a,function(c){var d=b.getHTML(c,a);b.par.lowerFingers(function(){b.show(c,a,d)})})})},show:function(a,b,c){var d=this;d.container.removeClass("red blue white black map img text text_img").addClass(b),a.img&&d.container.addClass("img"),a.text&&d.container.addClass("text"),a.text_img&&d.container.addClass("text_img"),d.container.find(".slide_wrapper").remove().end().append(c),require(["imagesLoaded"],function(){d.disabled||d.container.imagesLoaded(function(){d.container.fadeIn(),d.orient(b)})})},orient:function(a){var b=this,c=b.par.container.find(".finger_"+a),d=b.par.fingers_wrapper;!function(){var e=c.position().left,f=d.position().left,g=e+f,h=g-b.container.width()/2;"map"===a&&(h=Math.min(600,Math.max(g,h))),b.container.css("left",h)}(),function(){var a=b.par.container.height()-(c.position().top+300)-20;b.container.css("bottom",a)}()},selectContent:function(a,b){function d(a){c(a),a[0]===e.last_selected_item&&(a.splice(0,1),a.push(e.last_selected_item))}var e=this,f=this.data[a];f.slides?f.index===f.slides.length-1?(f.index=0,d(f.slides)):f.index++:(d(f),this.data[a]={slides:f,index:0},f=this.data[a]);var g=f.slides[f.index];this.last_selected_item=g,b&&b(g)},loadData:function(a){var b=this;this.data?a():$.getJSON(d+"fingers.json",function(c){b.data=c,a()})},getHTML:function(a,b){var c=$("<div>").addClass("slide_wrapper"),d=$("<table>").appendTo(c),e=$("<tr>").appendTo(d),f=$("<td>").appendTo(e);return(a.img||a.text_img)&&$("<img>").addClass("slide_img").attr("src","graphics/"+b+"/"+(a.img||a.text_img)).appendTo(f).fadeIn(),a.text&&$("<div>").addClass("book_wrapper").html(a.text).appendTo(f).fadeIn(),c},hide:function(a){return this.container.fadeOut(),a&&this.par.raiseFingers(),this},disable:function(){return this.disabled=!0,this},enable:function(){return this.disabled=!1,this}};new a("int")}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null===this)throw new TypeError(" this is null or not defined");var e=Object(this),f=e.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(b&&(c=b),d=0;f>d;){var g;d in e&&(g=e[d],a.call(c,g,d,e)),d++}});