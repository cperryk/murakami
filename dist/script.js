$(function(){function a(a){var c=this;this.container=$("<div>").addClass("int_inner").appendTo("#"+a),this.preloadImages().printTopBar().printFingers(function(){c.printMusicBtn()}).printBuyButton().printExcerptTeaser(),this.popup=new b(this)}function b(a){var b=this;this.par=a;var c=$("<div>").addClass("int_popup_wrapper").appendTo(this.par.container);this.container=$("<div>").addClass("int_popup").appendTo(c),this.btn_ex=$("<div>").addClass("btn_ex").html("x").appendTo(this.container).click(function(){b.hide(!0)})}function c(){$.ajax({url:"http://my.slate.com/store/segments/",dataType:"jsonp",success:function(a){var b=a.visitor.country.toLowerCase();$("a").each(function(){"http://www.amazon.com/dp/B00IHMEAYK/?tag=slatmaga-20"===$(this).attr("href")&&("canada"===b&&$(this).attr("href","http://www.amazon.ca/Colorless-Tsukuru-Tazaki-Years-Pilgrimage/dp/0385681836/ref=sr_1_1?tag=slatmaga-20"),("united kingdom"===b||"britain"===b||"great britain"===b||"england"===b)&&$(this).attr("href","http://www.amazon.co.uk/Colorless-Tsukuru-Tazaki-Years-Pilgrimage/dp/1846558336/ref=sr_1_1?tag=slatmaga-20"))})}})}function d(a){var b,c,d,e=a.length;if(0===e)return!1;for(;--e;)b=Math.floor(Math.random()*(e+1)),c=a[e],d=a[b],a[e]=d,a[b]=c}var e="http://www.slate.com/features/2014/06/murakami/";require.config({paths:{IntSound:e+"lib/intSound/intSound",SoundJS:e+"lib/soundjs/soundjs.min",SJS_FlashPlugin:e+"lib/soundjs/FlashPlugin",SJS_SwfObject:e+"lib/soundjs/swfobject",imagesLoaded:e+"lib/imagesLoaded.min",IntSharing:e+"lib/intSharing/intSharing"}});var f=["red","blue","white","black","map"],g={red:"note_e",blue:"note_g",white:"note_a",black:"note_a_sharp",map:"note_b"},h=["e","g","a","b","a_sharp","b","g","e"],i=["black/KURO_pottery.gif","map/TSUKURU_insidetrain.gif","map/TSUKURU_Overboard.gif","map/TSUKURU_recordplayer.gif","map/TSUKURU_train.gif"];a.prototype={preloadImages:function(){function a(a){$(a).each(function(){var a="graphics/"+this,c=$("<img/>").attr("src",e+a);b.preloaded[a]=c})}var b=this;return this.preloaded=[],a(i),this},printTopBar:function(){var a=this,b=$("<div>").addClass("top_bar").html("Please turn your sound up");return this.right_wrapper=$("<div>").addClass("right_wrapper").appendTo(b).click(function(){a.muteSound()}),this.top_bar_wrapper=b.appendTo(this.container),this},muteSound:function(){this.sound_muted=!0},printMusicBtn:function(){var a=this;return this.btn_music=$("<div>").hide().addClass("btn_music").appendTo(this.right_wrapper).fadeIn().click(function(){$(this).hasClass("active")?a.deactivatePianoView():a.activatePianoView()}),this},printFingers:function(a){var b=this,c=["red","blue","white","black","map"];return this.fingers_wrapper=$("<div>").addClass("fingers_wrapper").appendTo(this.container),this.fingers={},c.forEach(function(a,c){setTimeout(function(){var c=$("<div>").addClass("finger").data("type",a).addClass("finger_"+a).appendTo(b.fingers_wrapper).fadeIn();b.fingers[a]=c},200*c)}),setTimeout(a||null,1e3),this.addFingerClickListener(),this},addFingerClickListener:function(){var a=this;this.container.on("click.finger",".finger",function(){var b=$(this).data("type");a.fingerClicked(b)})},removeFingerClickListener:function(){this.container.unbind("click.finger")},fingerClicked:function(a){this.piano_view||this.popup.trigger(a)},addSoundListeners:function(){function a(a){for(var b in c.fingers)c.puzzle_complete||a.tieToButton(c.fingers[b],e+"sound/",g[b],{behavior:"key"})}function b(){var a=$(this).data("type");c.fingerPlayed(a)}var c=this;if(require(["IntSound"],function(b){b.initialize(e+"lib/soundjs",a)}),!c.puzzle_complete)for(var d in c.fingers)c.fingers.hasOwnProperty(d)&&c.fingers[d].unbind("click.piano").on("click.piano",b)},removeSoundListeners:function(){var a=$(".finger").unbind("click.piano");require(["IntSound"],function(b){b.untieButton(a)})},fingerPlayed:function(a){this.played_notes||(this.played_notes=[]);var b=g[a].replace("note_","");h[this.played_notes.length]===b?(this.notes[this.played_notes.length].html("&#9834;").addClass("correct"),this.played_notes.push(b),this.played_notes.length===h.length&&this.win()):(this.played_notes=[],this.bot.find(".correct").removeClass("correct")),this.highlightNote(a)},highlightNote:function(a){var b=this.piano_overlays[a];b.fadeIn(100,function(){b.fadeOut()})},win:function(){var a=this;this.puzzle_complete=!0,$(".finger").unbind("click.piano"),require(["IntSound"],function(a){a.untieButton($(".finger"))}),setTimeout(function(){require(["IntSound"],function(a){a.playSound(e+"sound/","note_b_1")}),a.highlightNote("final")},1e3),setTimeout(function(){a.showSolution()},1500)},printNotes:function(a){function b(){var a=$("<div>").html("&#9834;").addClass("note").appendTo(c.bot).animate({opacity:1},300);c.notes.push(a)}var c=this;this.notes=[];for(var d=h.length,e=0;d>e;e++)setTimeout(b,100*e);setTimeout(function(){a&&a()},700)},lowerFingers:function(a){this.fingers_wrapper.animate({"margin-top":300},500,function(){a&&a()})},raiseFingers:function(a){this.fingers_wrapper.animate({"margin-top":240},500,function(){a&&a()})},activatePianoView:function(){this.addSoundListeners(),this.piano_view=!0,this.popup.hide().disable(),this.btn_music.addClass("active"),this.showPiano(),this.showBot(),this.puzzle_complete&&this.showSolution()},deactivatePianoView:function(){this.removeSoundListeners(),this.btn_music.removeClass("active"),this.hidePiano(),this.hideBot(),this.puzzle_complete&&this.hideSolution(),this.popup.enable()},showPiano:function(){var a=this;return this.fingers_wrapper.animate({"margin-top":210},500),this.piano||(!function(){a.piano=$("<div>").addClass("piano").appendTo(a.container).show()}(),function(){a.piano_overlays={},a.overlay_wrapper||(a.overlay_wrapper=$("<div>").addClass("overlay_wrapper").appendTo(a.piano));var b=f.slice(0,f.length);b.push("final"),b.forEach(function(b){a.piano_overlays[b]=$("<img>").attr("src",e+"graphics/pianokey_"+b+".png").addClass("piano_overlay").addClass(b).appendTo(a.overlay_wrapper)})}()),this.piano.css("opacity",0).animate({opacity:1,top:a.top_bar_wrapper.outerHeight()},500),this},hidePiano:function(){var a=this;return this.piano_view=!1,this.piano.animate({opacity:0,top:-250},500,function(){a.hideBot()}),this.fingers_wrapper.animate({"margin-top":140},500),this},showBot:function(a){var b=this,c=!1;this.bot||(this.bot=$("<div>").addClass("bot").appendTo(this.container),c=!0),this.bot.fadeIn().animate({opacity:1,bottom:0},300,function(){c?b.printNotes(a):a&&a()})},hideBot:function(){this.bot.fadeOut()},getSolution:function(a){var b=this;this.solution?a(this.solution):$.getJSON(e+"solution.json",function(c){b.solution=c.solution,a(c.solution)})},showSolution:function(){var a=this;this.getSolution(function(b){var c=$("<div>").addClass("solution_wrapper").appendTo(a.container),d=($("<p>").addClass("solution_title").html("You solved Tsukuru Tazaki's puzzle!").appendTo(c),$("<div>").addClass("share_wrapper").appendTo(c));require(["IntSharing"],function(a){a.appendShareBtns(d,{fb:{head:"I solved Tsukuru Tazaki's puzzle!",desc:"Solve this puzzle and unlock an exclusive excerpt from Haruki Murakami's new novel.",img:"http://www.slate.com/content/dam/slate/articles/arts/books/2014/07/murakami/140728_FRESCA_mura-interactive-promo.jpg"},tw:{share_text:"I solved Tsukuru Tazaki's puzzle! Solve this puzzle and unlock an exclusive excerpt from Haruki Murakami's new novel."},email:{subject:"I solved Tsukuru Tazaki's puzzle!",body:"Solve this puzzle and unlock an exclusive excerpt from Haruki Murakami's new novel."}})});$("<div>").addClass("book_wrapper").html(b).appendTo(c),$("<div>").addClass("btn_ex").appendTo(c).html("X").click(function(){a.deactivatePianoView()});a.solution_wrapper=c.fadeIn()})},hideSolution:function(){var a=this;this.solution_wrapper&&this.solution_wrapper.fadeOut(function(){a.solution_wrapper.remove()})},printBuyButton:function(){var a=$("<div>").addClass("buy_wrapper").addClass("int_teaser"),b=$("<a>").attr("href","http://www.amazon.com/dp/B00IHMEAYK/?tag=slatmaga-20").attr("target","_blank").appendTo(a);return $("<img>").addClass("cover_art").attr("src",e+"graphics/coverart.jpg").appendTo(b),$("<p>").html("Order the Novel").addClass("teaser_label").appendTo(b),c(),$(window).width()>580?a.appendTo(this.container):a.insertAfter(this.container),this},printExcerptTeaser:function(){{var a=$("<div>").addClass("excerpt_teaser").addClass("int_teaser"),b=$("<a>").attr("href","http://www.slate.com/articles/arts/books/2014/07/haruki_murakami_excerpt_from_colorless_tsukuru_tazaki_and_his_years_of_pilgrimage.html").appendTo(a);$("<img>").addClass("cover_art").attr("src",e+"graphics/excerpt3.png").appendTo(b),$("<p>").addClass("teaser_label").html("Haida's Story").appendTo(b)}return $(window).width()>580?a.appendTo(this.container):a.insertAfter(this.container),this}},b.prototype={trigger:function(a){var b=this;this.container.hide(),this.loadData(function(){b.selectContent(a,function(c){var d=b.getHTML(c,a);b.par.lowerFingers(function(){b.show(c,a,d)})})})},show:function(a,b,c){var d=this;d.container.removeClass("red blue white black map img text text_img").addClass(b),a.img&&d.container.addClass("img"),a.text&&d.container.addClass("text"),a.video&&d.container.addClass("video"),d.container.find(".slide_wrapper").remove().end().append(c),require(["imagesLoaded"],function(){d.disabled||(d.par.removeFingerClickListener(),d.container.imagesLoaded(function(){d.container.fadeIn(function(){d.par.addFingerClickListener()}),d.orient(b)}))}),this.addClickListener()},orient:function(a){var b=this,c=b.par.container.find(".finger_"+a),d=b.par.fingers_wrapper;!function(){var e=c.position().left,f=d.position().left,g=e+f,h=Math.max(0,g-b.container.width()/2);"map"===a?h=Math.min(700,Math.max(g,h)):"red"===a&&(h=(f-b.container.width())/2),b.container.css("left",h)}(),function(){var a=b.par.container.height()-(c.position().top+300)-20;b.container.css({top:"auto",bottom:a}),b.container.position().top<0&&b.container.css({bottom:"auto",top:0})}()},selectContent:function(a,b){function c(a){d(a),a[0]===e.last_selected_item&&(a.splice(0,1),a.push(e.last_selected_item))}var e=this,f=this.data[a];f.slides?f.index===f.slides.length-1?(f.index=0,c(f.slides)):f.index++:(c(f),this.data[a]={slides:f,index:0},f=this.data[a]);var g=f.slides[f.index];this.last_selected_item=g,b&&b(g)},loadData:function(a){var b=this;this.data?a():$.getJSON(e+"fingers.json",function(c){b.data=c,a()})},getHTML:function(a,b){var c=$("<div>").addClass("slide_wrapper");if(a.img||a.text_img){var d,f="graphics/"+b+"/"+(a.img||a.text_img);d=this.par.preloaded[f]?this.par.preloaded[f]:$("<img>").attr("src",e+f),d.addClass("slide_img").appendTo(c).fadeIn()}if(a.text&&$("<div>").addClass("book_wrapper").html(a.text).appendTo(c).fadeIn(),a.video){var g=$("<video>").attr("loop",!0).html("Your browser does not support the video tag.");$("<source>").attr("src",e+"video/"+a.video+".mp4").attr("type","video/mp4").appendTo(g),$("<source>").attr("src",e+"video/"+a.video+".ogv").attr("type","video/ogg").appendTo(g),g.appendTo(c),g.get(0).play(),setTimeout(function(){g.get(0).play()},1e3)}return c},hide:function(a){var b=this;return this.container.fadeOut(function(){b.container.find(".slide_wrapper").empty()}),this.removeClickListener(),a&&this.par.raiseFingers(),this},disable:function(){return this.disabled=!0,this},enable:function(){return this.disabled=!1,this},addClickListener:function(){var a=this;this.par.container.on("click.popup",function(b){b.target;$(b.target).hasClass("finger")||0===$(b.target).parents(".int_popup").length&&a.hide(!0)})},removeClickListener:function(){this.par.container.unbind("click.popup")}};new a("int")}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null===this)throw new TypeError(" this is null or not defined");var e=Object(this),f=e.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(b&&(c=b),d=0;f>d;){var g;d in e&&(g=e[d],a.call(c,g,d,e)),d++}});